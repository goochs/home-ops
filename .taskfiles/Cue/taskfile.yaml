---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  CUE_DIR: "{{.ROOT_DIR}}/kubernetes/apps"
  CUE_MAIN: "{{.ROOT_DIR}}/kube.cue"

tasks:
  rebuild:
    desc: Rebuild the CUE directory
    dir: "{{.CUE_DIR}}"
    deps: [clean, fmt]
    cmds:
      - task: namespace_only
      - task: kustomization_only
      - task: untemplated_only
      - task: helm_only
  fmt:
    desc: Format CUE files
    dir: "{{.CUE_DIR}}"
    cmds:
      - cue fmt -s ./...
  clean:
    desc: Clean up the CUE directory
    deps: [clean-namespace, clean-kustomization, clean-untemplated, clean-helm]
  trim:
    desc: Trim the CUE directory
    dir: "{{.CUE_DIR}}"
    cmds:
      - find . -name "*.cue" -exec sh -c 'cue trim "{{.CUE_MAIN}}" {}' \;
  clean-namespace:
    desc: Clean up the CUE directory of namespace files
    dir: "{{.CUE_DIR}}"
    cmds:
      - find . -name "namespace*.yaml" -exec rm {} \;
  clean-kustomization:
    desc: Clean up the CUE directory of kustomization files
    dir: "{{.CUE_DIR}}"
    cmds:
      - find . -name "ks*.yaml" -exec rm {} \;
  clean-untemplated:
    aliases: [clean-misc]
    desc: Clean up the CUE directory of untemplated files
    dir: "{{.CUE_DIR}}"
    cmds:
      - find -E . ! -regex ".*(helm|ks|name).*yaml" -path "./*/*yaml" -exec rm {} \;
  clean-helm:
    desc: Clean up the CUE directory of helm files
    dir: "{{.CUE_DIR}}"
    cmds:
      - find . -name "helm*.yaml" -exec rm {} \;

  namespace_only:
    internal: true
    dir: "{{.CUE_DIR}}"
    cmds:
      - find . -name "namespace*.cue" -exec sh -c 'output=$(dirname {})/namespace.yaml; echo "---" >> $output; cue export -s "{{.CUE_MAIN}}" {} --out yaml >> $output' \;

  namespace:
    desc: Create namespace files
    dir: "{{.CUE_DIR}}"
    deps: [fmt, clean-namespace]
    cmds:
      - task: namespace_only

  kustomization_only:
    internal: true
    dir: "{{.CUE_DIR}}"
    cmds:
      - find . -name "ks*.cue" -exec sh -c 'output=$(dirname {})/ks.yaml; echo "---" >> $output; cue export -s "{{.CUE_MAIN}}" {} --out yaml >> $output' \;

  kustomization:
    aliases: [ks]
    deps: [fmt, clean-kustomization]
    dir: "{{.CUE_DIR}}"
    desc: Create kustomization files
    cmds:
      - task: kustomization_only

  untemplated_only:
    internal: true
    dir: "{{.CUE_DIR}}"
    cmds:
      - find -E . ! -regex ".*(helm|ks|name).*cue" -path "./*/*cue" -exec sh -c 'output=$(dirname {})/$(basename {} .cue).yaml; echo "---" >> $output; cue export -s "{{.CUE_MAIN}}" {} --out yaml >> $output' \;

  untemplated:
    aliases: [misc]
    deps: [fmt, clean-untemplated]
    dir: "{{.CUE_DIR}}"
    desc: Create untemplated files
    cmds:
      - task: untemplated_only

  helm_only:
    internal: true
    dir: "{{.CUE_DIR}}"
    cmds:
      - find . -name "helm*.cue" -exec sh -c 'output=$(dirname {})/helmrelease.yaml; echo "---" >> $output; cue export -s "{{.CUE_MAIN}}" {} --out yaml >> $output || echo $output' \;

  helm:
    deps: [fmt, clean-helm]
    dir: "{{.CUE_DIR}}"
    desc: Create helmrelease files
    cmds:
      - task: helm_only

  
